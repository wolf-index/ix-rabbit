<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Message Pump Demo</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css"
          type="text/css"/>
    <link rel="stylesheet" href="/static/css/message_pump.css"
          type="text/css"/>
</head>
<body>
<script src="/static/jquery-3.3.1.min.js"></script>
<script src="/static/paho-mqtt.js"></script>
<script src="/static/URI.min.js"></script>
<script src="/static/mustache.min.js"></script>
<script src="/static/popper.min.js"></script>
<script src="/static/moment.min.js"></script>
<script src="/static/bootstrap.min.js"></script>
<script src="mqtt_glue.js"></script>

<script>
    let my_client = null;
    let monkey_listener = null;
    const DT_FORMAT = 'YYYY-MM-DD HH:mm:ss';

    const alert_template = [
        '<div class="alert alert-{{ kind }}" role="alert">',
        '{{{ message }}}',
        '</div>'
    ].join("");
    const notification_message_template = [
        '<b>GOT</b>',
        '{{ dt_string }}',
        '{{ sensor_id }}/{{ capability_id }}',
        'with',
        '{{ values_str }}'
    ].join(" ");
    const published_message_template = [
        '<b>PUB</b>',
        '{{ dt_string }}',
        '{{ sensor_id }}/{{ capability_id }}',
        'with',
        '{{ values_str }}'
    ].join(" ");

    URI.preventInvalidHostname = true;

    function add_notification(args) {
        let ni_selector = $('#notification_items');
        let alerts_selector = ni_selector.find('div.alert');
        let alerts_threshold = 9;

        if (alerts_selector.length > alerts_threshold) {
            alerts_selector.slice(alerts_threshold).remove();
        }

        ni_selector.prepend(Mustache.render(alert_template, args));
    }

    function callback_notifications(message) {
        let data = JSON.parse(message.payloadString);

        // console.info(message.topic + ":");
        // console.info(JSON.stringify(data, null, 2));

        data['values_str'] = JSON.stringify(data.values);
        data['dt_string'] = moment.utc(data.publish_dt).format(DT_FORMAT);

        let args = {
            "kind": "primary",
            "message": Mustache.render(notification_message_template, data)
        };

        add_notification(args);
    }

    function on_hit(event) {
        event.preventDefault();
        let demo_value_selector = $('#a1_gesamtverfahrweg');

        let payload = {
            "sensor_id": "80eb07045af7d7b9",
            "capability_id": "c8df7e7997e2fb02",
            "values": [
                {
                    "a1_gesamtverfahrweg": demo_value_selector.val()
                }
            ]
        };
        let randy = Math.floor(Math.random() * 10) % 10;
        demo_value_selector.val(randy);

        try {
            let sent_dt_string = moment.utc().format(DT_FORMAT);
            let message = new Paho.Message(JSON.stringify(payload));
            message.destinationName = "test";
            my_client.send(message);
            // "Published MQTT message to <b>" + message.destinationName + "</b>",
            payload['values_str'] = JSON.stringify(payload.values);
            payload['dt_string'] = sent_dt_string;
            let args = {
                "message": Mustache.render(published_message_template, payload),
                "kind": "secondary"
            };
            add_notification(args);
        }
        catch (e) {
            console.error(e);
            return;
        }
    }

    $(document).ready(function () {
        console.log("ready!");
        my_client = add_mqtt_listener("test");
        $("#gimme").on("click", on_hit);
        monkey_listener = add_mqtt_listener("notifications", callback_notifications);
        $('[data-toggle="tooltip"]').tooltip()
    });
</script>

<section id="message_pump" class="container">
    <div class="d-flex justify-content-center">
        <form id="foermchen" method="post" action="/message_pump.html">
            <div id="request_form_container">
                <h1>Message Pump Demo</h1>

                <div class="input-group">
                    <input id="a1_gesamtverfahrweg" type="text"
                           class="form-control measures_item"
                           placeholder="1" value="-1"
                           data-toggle="tooltip" data-placement="top"
                           title="Tooltip on right"
                    >

                    <div class="input-group-append">
                        <input id="gimme" type="submit"
                               class="btn btn-primary"
                               value="gimme">
                    </div>
                </div>

                <!--
                <hr>

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input"
                           id="email_notification">
                    <label class="custom-control-label"
                           for="email_notification">Send email if
                        ...</label>
                </div>

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input"
                           id="keep_override_value">
                    <label class="custom-control-label"
                           for="keep_override_value">Keep override
                        value...</label>
                </div>

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input"
                           id="auto_download">
                    <label class="custom-control-label"
                           for="auto_download">Download</label>
                </div>

                <hr>

                <h4>Overrides <span class="text-muted">(Optional)</span></h4>

                <div>
                    <label for="album">Album</label>
                    <input type="text" class="form-control" id="album"
                           placeholder="fancy value">
                </div>
                -->
            </div>
        </form>
    </div>
</section>

<section id="notifications">
    <div class="container">
        <div class="row">
            <div id="notification_items" class="col-md-12"></div>
        </div>
    </div>
</section>

</body>
</html>