<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ix-rabbit</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css"
          type="text/css"/>
    <link rel="stylesheet" href="/static/css/message_pump.css"
          type="text/css"/>
</head>
<body>
<script src="/static/jquery-3.3.1.min.js"></script>
<script src="/static/paho-mqtt.js"></script>
<script src="/static/URI.min.js"></script>
<script src="/static/mustache.min.js"></script>
<script src="/static/popper.min.js"></script>
<script src="/static/bootstrap.min.js"></script>
<script src="mqtt_glue.js"></script>

<script>
    let my_client = null;
    let monkey_listener = null;
    const alert_template = [
        '<div class="alert alert-{{ kind }}" role="alert">',
        '{{{ message }}}',
        '</div>'
    ].join("");

    let fake_errors = [
        {},
        {
            "message": "Severe error",
            "may_try_again": false
        },
        {
            "message": "Not so severe error",
            "may_try_again": true
        }
    ];

    URI.preventInvalidHostname = true;

    function add_notification(args) {
        let ni_selector = $('#notification_items');
        let alerts_selector = ni_selector.find('div.alert');
        let alerts_threshold = 9;

        if(alerts_selector.length > alerts_threshold) {
            alerts_selector.slice(alerts_threshold).remove();
        }

        ni_selector.prepend(Mustache.render(alert_template, args));
    }

    function callback_notifications(message) {
        let data = JSON.parse(message.payloadString);

        // console.info(message.topic + ":");
        // console.info(JSON.stringify(data, null, 2));

        let args = {
            "kind": "primary",
            "message": "it's all good man"
        };

        if (data.error) {
            args = {
                "message": data.error.message,
                "kind": "warning"
            };

            if(false === data.error.may_try_again) {
                args["kind"] = "danger"
            }
        }

        add_notification(args);
    }

    function on_hit(event) {
        event.preventDefault();
        // console.debug("Hit me baby one more time");
        let the_url = null;
        let url_selector = $('#url');
        let album_selector = $('#album');
        let raw_url_value = url_selector.val();
        let override_album = album_selector.val();

        if (override_album) {
            override_album = override_album.trim();
        }

        if (!raw_url_value) {
            let args = {
                "message": "No URL value?",
                "kind": "warning"
            };
            console.error(args.message);
            add_notification(args);
            return;
        }

        raw_url_value = raw_url_value.trim();

        console.info("'" + raw_url_value + "'");
        try {
            the_url = new URI(raw_url_value);
        }
        catch (e) {
            let args = {
                "message": "Invalid URL",
                "kind": "error"
            };
            console.error(args.message);
            add_notification(args);
            return;
        }

        let supported_scheme = (the_url.scheme() == 'http' || the_url.scheme() == 'https');

        if (false === supported_scheme) {
            let args = {
                "message": "Unsupported scheme",
                "kind": "danger"
            };
            console.error(args.message);
            add_notification(args);
            return;
        }

        let payload = {
            "url": the_url.toString(),
            "email_notification": $('#email_notification').is(":checked"),
            "overrides": {}
        };

        let randy = Math.floor(Math.random() * 10);
        let error_item = fake_errors[randy % fake_errors.length];
        if (false === $.isEmptyObject(error_item)) {
            payload['error'] = error_item;
        }

        if (override_album) {
            payload['overrides']['album'] = override_album;
        }

        if (false === $('#keep_override_value').is(":checked")) {
            album_selector.val('');
        }

        try {
            let message = new Paho.Message(JSON.stringify(payload));
            message.destinationName = "test";
            my_client.send(message);
            let args = {
                "message": "Added something",
                "kind": "success"
            };
            add_notification(args);
            // url_selector.val('');
        }
        catch (e) {
            console.error(e);
            return;
        }
    }

    $(document).ready(function () {
        console.log("ready!");
        my_client = add_mqtt_listener("test");
        $("#gimme").on("click", on_hit);
        monkey_listener = add_mqtt_listener("notifications", callback_notifications);
        $('[data-toggle="tooltip"]').tooltip()
    });
</script>

<section id="message_pump">
    <div class="container">
        <div class="row">
            <h1>Message Pump Demo</h1>
        </div>

        <div class="row">
            <form id="foermchen" method="post" action="/message_pump.html">
                <div class="col-md-12">
                    <div class="input-group">
                        <input id="url" type="text" class="form-control"
                               placeholder="http://bla.org"
                               value="http://example.com"
                               data-toggle="tooltip" data-placement="left" title="Tooltip on right"
                        >

                        <div class="input-group-append">
                            <input id="gimme" type="submit"
                                   class="btn btn-primary"
                                   value="gimme">
                        </div>
                    </div>
                </div>
                <hr>
                <div class="col-md-12">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input"
                               id="email_notification">
                        <label class="custom-control-label"
                               for="email_notification">Send email if
                            ...</label>
                    </div>

                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input"
                               id="keep_override_value">
                        <label class="custom-control-label"
                               for="keep_override_value">Keep override
                            value...</label>
                    </div>

                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input"
                               id="auto_download">
                        <label class="custom-control-label"
                               for="auto_download">Download</label>
                    </div>
                </div>
                <hr>
                <div class="col-md-12">
                    <h4>Overrides <span class="text-muted">(Optional)</span>
                    </h4>
                    <div class="mb-3">
                        <label for="album">Album</label>
                        <input type="text" class="form-control" id="album"
                               placeholder="fancy value">
                    </div>

                </div>
            </form>
        </div>
    </div>
</section>

<section id="notifications">
    <div class="container">
        <div class="row">
            <div id="notification_items" class="col-md-12"></div>
        </div>
    </div>
</section>

</body>
</html>